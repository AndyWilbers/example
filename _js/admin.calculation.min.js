var calculation={setup:function(){calculation.setup_ar_form()},setup_ar_form:function(){if(1==$("#calculation-ar").size()){$(document).on("submit","#calculation-ar",function(a){a.preventDefault();var t={};t.form_id=$(this).attr("id");var e="";t.to_delete={},t.to_delete.inp={},t.to_delete.act={},t.to_delete.sco={},t.to_delete.alg={},$.each($(this).serializeArray(),function(a,n){e=$('input[name="'+n.name+'"][data-default*="NULL"], input[name="'+n.name+'"][data-default*="null"]').size()>0&&""==n.value?"NULL":n.value;var r=n.name.split("_"),o=r.shift();switch(o){case"inp":if(t.hasOwnProperty("inp")||(t.inp={}),"to_delete"==r.join("_")){t.to_delete.inp=e.split(";");break}var i=r.shift(),a=r.join("_");t.inp.hasOwnProperty(i)||(t.inp[i]={},t.inp[i].act={},t.to_delete.act[i]={}),t.inp[i][a]=e;break;case"act":t.hasOwnProperty("inp")||(t.inp={});var c=r.shift();if(t.inp.hasOwnProperty(c)||(t.inp[c]={},t.inp[c].act={},t.to_delete.act[c]={}),"to_delete"==r.join("_")){t.to_delete.act[c]=e.split(";");break}var i=r.shift();t.inp[c].act.hasOwnProperty(i)||(t.inp[c].act[i]={});var a=r.join("_");t.inp[c].act[i][a]=e;break;case"alg":if(t.hasOwnProperty("alg")||(t.alg={}),"to_delete"==r.join("_")){t.to_delete.alg=e.split(";");break}var i=r.shift(),a=r.join("_");t.alg.hasOwnProperty(i)||(t.alg[i]={}),t.alg[i][a]=e;break;case"sco":if(t.hasOwnProperty("sco")||(t.sco={}),"to_delete"==r.join("_")){t.to_delete.sco=e.split(";");break}var i=r.shift(),a=r.join("_");t.sco.hasOwnProperty(i)||(t.sco[i]={}),t.sco[i][a]=e;break;default:t[n.name]=e}}),t.hasOwnProperty("inp")&&(t.inp=JSON.stringify(t.inp)),t.hasOwnProperty("alg")&&(t.alg=JSON.stringify(t.alg)),t.hasOwnProperty("sco")&&(t.sco=JSON.stringify(t.sco)),t.to_delete=JSON.stringify(t.to_delete),$(this).find('[data-ce*="type:radio;"].checked').each(function(){var a=ce.data($(this).attr("data-ce"));t[a.name]=a.value});var n=1===$(this).find(".publish").size()?$(this).find(".publish"):null;if(null!==n&&(t.publish=n.hasClass("not")?-1:1),"on"==debug){var r=window.location.href;r=r.toLowerCase(),r.indexOf("?show")>0||r.indexOf("&show")>0||"on"===show}var o=new gen.ajax("");window.console.info($(this).attr("data-sa"));var i=sa.data($(this).attr("data-sa"));window.console.info(i.submit),window.console.info(i.callback),o.post({url:i.submit,data:t,callback:i.callback})}),$(document).on("click",'.tab[data-sa*="group"][data-sa*="show"]',function(){var a=sa.data($(this).attr("data-sa")),t=a.group,e=a.show;$('.tab[data-sa*="group:'+t+'"]').not('[data-sa*="show:'+e+'"]').removeClass("active"),$(this).addClass("active"),$('.tab-container[data-sa*="group:'+t+'"]').not('[data-sa*="name:'+e+'"]').addClass("hide"),$('.tab-container[data-sa*="name:'+e+'"]').removeClass("hide"),$('input[name="tab"]').val(a.tab).trigger("change")}),$(document).on("change",'[name^="inp_"],[name^="act_"]',function(){calculation.inputs.propagate_change($(this))}),$(document).on("change",'[name^="alg_"]',function(){calculation.algorithms.propagate_change($(this))}),$(document).on("change",'[name^="sco_"]',function(){calculation.scores.propagate_change($(this))}),$(document).on("change",'[name^="act_"][name*="_description"]',function(){calculation.description.propagate_change($(this))}),$(document).on("change",'[name^="inp_"][name*="FID_OBSERVATION"]',function(){calculation.fid_observation.propagate_change($(this))}),$(document).on("change",'[name*="FID_ARTICLE"]',function(){calculation.fid_article.propagate_change($(this))}),$(document).on("change",'[name*="FID_CALCULATION_NEXT"]',function(){calculation.fid_calculation_next.propagate_change($(this))});var a=form.data.get($("#calculation-ar"));if(a.hasOwnProperty("tab")){var t=a.tab;$('.tab[data-sa*="group"][data-sa*="show"][data-sa*="'+t+'"]').trigger("click")}if($('[name^="inp_"],[name^="act_"]').each(function(){var t=$(this).attr("name");a.hasOwnProperty(t)&&calculation.inputs.propagate_change($(this))}),$('[name^="alg_"]').each(function(){var t=$(this).attr("name");a.hasOwnProperty(t)&&calculation.algorithms.propagate_change($(this))}),$('[name^="sco_"]').each(function(){var t=$(this).attr("name");a.hasOwnProperty(t)&&calculation.scores.propagate_change($(this))}),$('[name^="act_"][name*="_description"]').each(function(){var t=$(this).attr("name");a.hasOwnProperty(t)&&calculation.description.propagate_change($(this))}),$('[name^="inp_"][name*="FID_OBSERVATION"]').each(function(){var t=$(this).attr("name");a.hasOwnProperty(t)&&calculation.fid_observation.propagate_change($(this))}),$('[name*="FID_ARTICLE"]').each(function(){var t=$(this).attr("name");a.hasOwnProperty(t)&&calculation.fid_article.propagate_change($(this))}),$('[name*="FID_CALCULATION_NEXT"]').each(function(){var t=$(this).attr("name");a.hasOwnProperty(t)&&calculation.fid_calculation_next.propagate_change($(this))}),$.each(a,function(a,t){if(-1!=a.indexOf("_to_delete")){var e=a.replace("_to_delete",""),n=t.split(";"),r=';"], tr[data-sa*="row:'+e+';"][data-sa*="indx:',o='tr[data-sa*="row:'+e+';"][data-sa*="indx:'+n.join(r)+';"]';$(o).addClass("remove")}}),a.hasOwnProperty("new_fields")){var e=a.new_fields.split("|"),n={};$.each(e,function(a,t){var e=sa.data(t),r=e.row,o=e.indx,i=null;if(-1!==r.indexOf("_")){var c=r.split("_");r=c[0],i=c[1]}n.hasOwnProperty(r)||(n[r]=null==i?[]:{}),null==i?n[r].push(o):(n[r].hasOwnProperty(i)||(n[r][i]=[]),n[r][i].push(o))});var r=sa.dataSA($("html").eq(0).attr("data-sa")),o=new gen.ajax(""),i=calculation.convert_to_nested(a);$.each(["inp","act","alg","sco"],function(a,t){var e=i.hasOwnProperty(t)?i[t]:{};n.hasOwnProperty(t)&&$.each(n[t],function(a){if(Array.isArray(n[t][a]))$.each(n[t][a],function(c){var l=a;e=e.hasOwnProperty(l)?e[l]:{};var s=n[t][a][c],d=e.hasOwnProperty(s)?e[s]:{};d.indx=s,d.inp=l,d.pos=d.hasOwnProperty("position")?d.position:100;var p=i.hasOwnProperty("inp")?i.inp:{};p=p.hasOwnProperty(l)?p[l]:{};var h=p.hasOwnProperty("FID_OBSERVATION")?p.FID_OBSERVATION:-1;d.FID_OBSERVATION=parseInt(h,10),o.get({url:r.application+"/calculation/ajax/get_"+t+"_row",data:d,callback:"calculation.callback_add_row"})});else{var c=n[t][a],l=e.hasOwnProperty(n[t][a])?e[n[t][a]]:{};l.indx=c,l.pos=l.hasOwnProperty("position")?l.position:100,o.get({url:r.application+"/calculation/ajax/get_"+t+"_row",data:l,callback:"calculation.callback_add_row"})}})})}}},convert_to_nested:function(a){var t={};return $.each(a,function(a,e){var n=a.split("_");if(n.length>0){var r=[];if(r.push(n.shift()),n.length>0){for(var o=n.shift();$.isNumeric(o)&&n.length>0;)r.push(parseInt(o,10)),o=n.shift();n.length>0&&(o+="_"+n.join("_")),r.push(o)}t=calculation.convert_to_nested_add(t,r,e)}}),t},convert_to_nested_add:function(a,t,e){var n=t.shift();return a.hasOwnProperty(n)||(a[n]={}),a[n]=t.length>0?calculation.convert_to_nested_add(a[n],t,e):e,a},get_new_row:function(a,t){var e={};e.pos=100,e.indx=1;var n=t.parents('tr[data-sa*="row:inp;"]'),r="";if(1==n.size()){var o=sa.data(n.attr("data-sa"));e.inp=parseInt(o.indx,10),r="_"+e.inp}var i=a,c=$('tr[data-sa*="row:'+i+r+';"]');if(c.size()>0){var l=c.last(),s=sa.data(l.attr("data-sa"));e.indx=s.hasOwnProperty("indx")?parseInt(s.indx)+1:1;var d=gen.find_max_val('tr[data-sa*="row:'+i+r+';"] input[name$="_position"]');null!==d&&(e.pos=parseInt(d,10)+100)}if("act"==i){var p=$('[name="inp_'+e.inp+'_FID_OBSERVATION"]').val();e.FID_OBSERVATION=parseInt(p,10)}var h=sa.dataSA($("html").eq(0).attr("data-sa")),u=new gen.ajax("");u.get({url:h.application+"/calculation/ajax/get_"+i+"_row",data:e,callback:"calculation.callback_add_row"})},callback_add_row:function(a){var t=form.data.get($("#calculation-ar"));if(parseInt(a.meta.error,10)<0)return void("on"==debug&&window.console.error(JSON.stringify(a)));var e=a.row_type;0==$("#calculation_"+e+'>tbody>tr[data-sa*="row:'+e+';"]').size()?$("#calculation_"+e+">tbody").html(a.html):$("#calculation_"+e+'>tbody>tr[data-sa*="row:'+e+';"]:last').after(a.html);var n=$("#calculation_"+e+'>tbody>tr[data-sa*="row:'+e+';"]:last');if(t.hasOwnProperty(e+"_to_delete")){var r=";"+t[e+"_to_delete"]+";",o=sa.data(n.attr("data-sa")),i=o.indx;if(r.indexOf(";"+i+";")>=0){var c=n.find('[data-sa*="onClick:"][data-sa*=".remove"]');calculation.remove(c)}}n.find("[name]").trigger("change");var l=t.hasOwnProperty("new_fields")?t.new_fields:"",o=n.attr("data-sa");if(-1==l.indexOf(o)){var s=l.length>0?"|":"";l+=s+o}form.data.set($("#calculation-ar"),"new_fields",l)},popup:{get:function(a){if(!a.hasOwnProperty("name")&&"on"==debug)return void window.console.error("name not defined.");var t={};t.name=a.name,t.val=$('[name="'+a.name+'"]').val(),t.action_ok="calculation.popup.update",t.ID=$('input[name="ID"]').val();var e=sa.dataSA($("html").eq(0).attr("data-sa")),n=new gen.ajax("");n.get({url:e.application+"/calculation/ajax/get_popup",data:t,callback:"calculation.popup.callback"})},callback:function(a){parseInt(a.meta.error,10)<0||($("#box-content").html(a.html),$("#popup").removeClass("ui-closed"))},update:function(){var a=$("#record").val(),t=$("#record").attr("data-name");$('[name="'+t+'"]').val(a),$('[name="'+t+'"]').trigger("change"),$("#popup").addClass("ui-closed")}},inputs:{propagate_change:function(a){var t=a.attr("name"),e=t.split("_"),n=e[1];$('.btn[data-sa="inp-'+n+'"]').addClass("changed"),$('.tab[data-sa*="show:inputs"] label').addClass("changed")},add:function(a){calculation.get_new_row("inp",a.me)},remove:function(a){calculation.remove(a.me)},actions:{add:function(a){calculation.get_new_row("act",a.me)},remove:function(a){calculation.remove(a.me)}}},algorithms:{propagate_change:function(){$('.tab[data-sa*="show:algorithm;"] label').addClass("changed")},add:function(a){calculation.get_new_row("alg",a.me)},remove:function(a){calculation.remove(a.me)}},scores:{propagate_change:function(){$('.tab[data-sa*="show:scores;"] label').addClass("changed")},add:function(a){calculation.get_new_row("sco",a.me)},remove:function(a){calculation.remove(a.me)}},fid_observation:{propagate_change:function(a){var t={};t.name=a.attr("name"),t.ID=a.val();var e=sa.dataSA($("html").eq(0).attr("data-sa")),n=new gen.ajax("");n.get({url:e.application+"/observation/ajax/get_record_by_id",data:t,callback:"calculation.fid_observation.callback"})},callback:function(a){if(!(parseInt(a.meta.error,10)<0)){var t=sa.dataSA($("html").eq(0).attr("data-sa")),e=t.path+t.application+"/admin/observations",n=a.inputData.name,r=$('[data-sa*="name:'+n+'"]').siblings("p").eq(0).find("a"),o=a.ar.hasOwnProperty("name")?a.ar.name:r.attr("data-text"),i=a.ar.hasOwnProperty("href")?e+"/"+a.ar.href:e;r.addClass("changed").text(o).attr("href",i),$('[data-sa*="name:'+n+'"]').addClass("changed");var c=n.split("_"),l=c[1],s=$("#calculation_act_"+l+' tbody tr select[name$="_rule"]'),d={};d.ID=a.inputData.ID,d.selectors={},s.each(function(){d.selectors[$(this).attr("name")]=$(this).val()});var t=sa.dataSA($("html").eq(0).attr("data-sa")),p=new gen.ajax("");p.get({url:t.application+"/observation/ajax/get_options_after_update",data:d,callback:"calculation.fid_observation.callback_update_options"})}},callback_update_options:function(a){$.each(a.selectors,function(a,t){var e=$('[name="'+a+'"]'),n=e.val();e.html(t.html),n!=t.value&&e.val(t.value).trigger("change")})}},description:{propagate_change:function(a){var t=a.val(),e=a.attr("name"),n=$('[data-sa*="name:'+e+'"]').attr("title"),r=n.split('"');r[1]=t,n=r.join('"'),$('[data-sa*="name:'+e+'"]').attr("title",n).addClass("changed"),calculation.inputs.propagate_change(a)}},fid_article:{propagate_change:function(a){var t={};t.name=a.attr("name"),t.ID=a.val();var e=sa.dataSA($("html").eq(0).attr("data-sa")),n=new gen.ajax("");n.get({url:e.application+"/article/ajax/get_record_by_id",data:t,callback:"calculation.fid_article.callback"})},callback:function(a){var t=a.inputData.name;if(!(parseInt(a.meta.error,10)<0)){var e=sa.dataSA($("html").eq(0).attr("data-sa")),n=e.path+e.application+"/admin/articles",r=$('[data-link*="'+t+'"]'),o=a.ar.hasOwnProperty("name")?a.ar.name:r.attr("data-title"),i=a.ar.hasOwnProperty("ID")?a.ar.ID:"NULL",c=a.ar.hasOwnProperty("href")?n+"/"+a.ar.href:n;$('[data-sa*="name:'+t+'"]').addClass("changed"),r.text(i).addClass("changed").attr("title",o).attr("href",c)}}},fid_calculation_next:{propagate_change:function(a){var t={};t.name=a.attr("name"),t.ID=a.val();var e=sa.dataSA($("html").eq(0).attr("data-sa")),n=new gen.ajax("");n.get({url:e.application+"/calculation/ajax/get_record_by_id",data:t,callback:"calculation.fid_calculation_next.callback"})},callback:function(a){if(!(parseInt(a.meta.error,10)<0)){var t=sa.dataSA($("html").eq(0).attr("data-sa")),e=t.path+t.application+"/admin/calculations",n=a.inputData.name,r=$('[data-link*="'+n+'"]'),o=a.ar.hasOwnProperty("name")?a.ar.name:r.attr("data-title"),i=a.ar.hasOwnProperty("ID")?a.ar.ID:"NULL",c=a.ar.hasOwnProperty("href")?e+"/"+a.ar.href:e;$('[data-sa*="name:'+n+'"]').addClass("changed");var r=$('[data-link*="'+n+'"]');r.text(i).addClass("changed").attr("title",o).attr("href",c)}}},remove:function(a){var t=sa.data(a.attr("data-sa"));if(t.hasOwnProperty("row")&&t.hasOwnProperty("indx")){var e=t.indx,n=t.row,r=a.parents('tr[data-sa*="row:'+n+';"][data-sa*="indx:'+e+';"]');r.toggleClass("remove");var o=a.text(),i=a.attr("title");a.text(a.attr("data-label")),a.attr("title",a.attr("data-title")),a.attr("data-label",o),a.attr("data-title",i);var c=t.row+"_to_delete",l="",s="";$('tr[data-sa*="row:'+n+';"]').each(function(){if($(this).hasClass("remove")){var a=sa.data($(this).attr("data-sa"));a.hasOwnProperty("indx")&&(l+=s+a.indx,s=";")}}),$('input[name="'+c+'"]').val(l),$('input[name="'+c+'"]').trigger("change")}}};